<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.bootcss.com/element-ui/2.13.2/theme-chalk/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../css/yxt.css">
    <title>消息中心</title>
    <style>
        #message-setting-divider {
            margin: 15px 0 10px 0;
        }

        .el-divider--horizontal {
            margin: 5px 0 5px 0;
        }

        #chat-card>.el-card__body {
            padding: 0;
        }

        #chat-textarea {
            resize: none;
            padding: 10px 30px;
            height: 80%;
            width: 100%;
            border: none;
            outline: 0;
            box-sizing: border-box;
            font-size: 14px;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="app">
        <el-container>
            <!-- 头部 -->
            <el-header>
                <!-- 导航栏：logo、菜单功能、头像下拉菜单 -->
                <el-row>
                    <!-- logo -->
                    <el-col :span="4">
                        <!-- <el-image style="margin-top: 10px;" src="./images/logo_blue.png" fit="contain"></el-image> -->
                        <el-image>
                            <div slot="error" class="image-slot">
                                <div class="header-logo">LOGO</div>
                            </div>
                        </el-image>
                    </el-col>
                    <!-- 菜单功能 -->
                    <el-col :span="16">
                        <el-menu mode="horizontal">
                            <el-menu-item index="1" class="header-text" @click="location.href = '../homePage.html'">课堂
                            </el-menu-item>
                            <el-menu-item index="2" class="header-text">精品课程</el-menu-item>
                            <el-menu-item index="3" class="header-text">本校课程</el-menu-item>
                            <el-menu-item index="4" class="header-text">我的精品</el-menu-item>
                        </el-menu>
                    </el-col>
                    <!-- 消息提醒 -->
                    <el-col :span="1.5">
                        <el-menu class="el-menu-demo" mode="horizontal">
                            <el-submenu>
                                <template slot="title">
                                    <i class="el-icon-bell"></i>
                                    <el-badge v-show="totalUnreadCount != 0" :value="totalUnreadCount" :max="10"
                                        class="item">
                                </template>
                                <el-menu-item><i class="el-icon-message-solid"></i> 系统通知 <el-badge
                                        v-if="unreadMessageCount.systemMessageCount != 0"
                                        :value="unreadMessageCount.systemMessageCount" class="item">
                                </el-menu-item>
                                <el-menu-item><i class="el-icon-notebook-2"></i> 课程相关 <el-badge
                                        v-if="unreadMessageCount.courseMessageCount != 0"
                                        :value="unreadMessageCount.courseMessageCount" class="item">
                                </el-menu-item>
                                <el-menu-item><i class="fa fa-mail-forward"
                                        style="margin-left: 6px; margin-right: 10px;"></i>
                                    回复我的 <el-badge v-if="unreadMessageCount.replyMessageCount != 0"
                                        :value="unreadMessageCount.replyMessageCount" class="item">
                                </el-menu-item>
                                <el-menu-item><i class="fa fa-thumbs-o-up"
                                        style="margin-left: 6px; margin-right: 12px;"></i> 收到的赞 <el-badge
                                        v-if="unreadMessageCount.voteUpMessageCount != 0"
                                        :value="unreadMessageCount.voteUpMessageCount" class="item">
                                </el-menu-item>
                                <el-menu-item><i class="el-icon-chat-dot-round"></i> 我的私信 <el-badge
                                        v-if="unreadMessageCount.chatMessageCount != 0"
                                        :value="unreadMessageCount.chatMessageCount" class="item">
                                </el-menu-item>
                            </el-submenu>
                        </el-menu>
                    </el-col>
                    <!-- 头像下拉菜单 -->
                    <el-col :span="2.5">
                        <el-menu class="el-menu-demo" mode="horizontal">
                            <el-submenu>
                                <template slot="title">
                                    <span v-text="user.username" style="color: black; margin: 20px 10px;">用户名</span>
                                    <el-avatar size="large" :src="user.avatar">
                                    </el-avatar>
                                </template>
                                <el-menu-item @click="location.href = 'setting.html' "><i class="el-icon-setting"></i>
                                    个人设置</el-menu-item>
                                <el-menu-item><i class="el-icon-position"></i> 消息中心</el-menu-item>
                                <el-menu-item @click="logout()"><i class="fa fa-sign-out"
                                        style="margin-left: 6px; margin-right: 9px;"></i>
                                    <span>退出账户</span>
                                </el-menu-item>
                            </el-submenu>
                        </el-menu>
                    </el-col>
                </el-row>
            </el-header>

            <!-- 中间 -->
            <el-container>
                <!-- 左侧导航栏 -->
                <el-aside width="300px" style="overflow: hidden;">
                    <div id="menu" style="padding-top: 150px">
                        <el-menu default-active="1">
                            <el-menu-item index="1" @click="show('isSystemMessageVisible')">
                                <i class="el-icon-message-solid"></i>
                                <span slot="title">系统通知</span>
                            </el-menu-item>
                            <el-menu-item index="2" @click="show('isCourseMessageVisible')">
                                <i class="el-icon-notebook-2"></i>
                                <span slot="title">课程相关</span>
                            </el-menu-item>
                            <el-menu-item index="3" @click="show('isReplyMessageVisible')">
                                <i class="fa fa-mail-forward" style="margin-left: 6px; margin-right: 9px;"></i>
                                <span slot="title">回复我的</span>
                            </el-menu-item>
                            <el-menu-item index="4" @click="show('isVoteUpMessageVisible')">
                                <i class="fa fa-thumbs-o-up" style="margin-left: 6px; margin-right: 9px;"></i>
                                <span slot="title">收到的赞</span>
                            </el-menu-item>
                            <el-menu-item index="5" @click="show('isChatMessageVisible')">
                                <i class="el-icon-chat-dot-round"></i>
                                <span slot="title">我的私信</span>
                            </el-menu-item>
                            <el-menu-item index="6" @click="show('isMessageSettingVisible')">
                                <i class="el-icon-setting"></i>
                                <span slot="title">消息设置</span>
                            </el-menu-item>
                        </el-menu>
                    </div>
                </el-aside>
                <!-- 中间 -->
                <el-main>
                    <div style="margin-left: 60px">
                        <el-row>
                            <el-col :span="3"></el-col>
                            <el-col :span="14">
                                <!-- 系统通知 -->
                                <div v-show="visible.isSystemMessageVisible">
                                    <el-card shadow="never"
                                        style="margin-top: 100px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row>
                                            <el-col :span="1.5">
                                                系统通知
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <!-- 系统通知列表 -->
                                    <el-card shadow="hover" v-for="(systemMessage, index) in systemMessageList"
                                        v-if="systemMessageList.length > 0"
                                        style="margin-top: 10px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row style="float: left;">
                                            <el-col>
                                                <span style="color: #333; font-weight: 700;"
                                                    v-text="systemMessage.title">系统通知标题</span>
                                                <i class="el-icon-time" style="margin-left: 20px;"></i>
                                                <span style="color: #999; font-size: small;"
                                                    v-text="systemMessage.publishTime">2020年11月23日 16:31</span>
                                            </el-col>
                                        </el-row>
                                        <el-row>
                                            <el-col :span="24">
                                                <span
                                                    style="float: left;padding-left: 30px;padding-top: 5px;margin-top: 10px;">
                                                    <span v-html="systemMessage.content"
                                                        style="font-size: 15px;color: #707070">这是系统通知内容这是系统通知内容这是系统通知内容这是系统通知内容这是系统通知内容</span>
                                                </span>
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <el-card class="box-card" v-if="systemMessageList.length === 0" shadow="hover"
                                        style="margin-top: 20px;width: 1184px;height: 220px;border-radius: 10px;border-width: 2px">
                                        <el-row>
                                            <p
                                                style="text-align: center; font-size: 15px; color: black; line-height: 160px;">
                                                暂无系统通知</p>
                                        </el-row>
                                    </el-card>
                                </div>

                                <!-- 课程相关 -->
                                <div v-show="visible.isCourseMessageVisible">
                                    <el-card shadow="never"
                                        style="margin-top: 100px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row>
                                            <el-col :span="1.5">
                                                课程相关
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <!-- 课程相关列表 -->
                                    <el-card shadow="hover" v-if="courseRemindList.length > 0"
                                        style="margin-top: 10px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <div v-for="(courseRemind, index) in courseRemindList" :key="courseRemind.id"
                                            @mouseover="showDel.courseRemindId = courseRemind.id"
                                            @mouseout="showDel.courseRemindId = -1">
                                            <el-row style="margin-top: 20px;">
                                                <el-col :span="1">
                                                    <el-avatar size="small" :src="courseRemind.sender.avatar">
                                                    </el-avatar>
                                                </el-col>
                                                <el-col :span="2.5" style="margin-top: 5px;">
                                                    <span style="font-size: 14px; color: #222;"
                                                        v-text="courseRemind.sender.username">Colin</span>
                                                    <span style="color: #999; font-size: small;"> <span
                                                            v-text="courseRemind.action">上传</span>了新<span
                                                            v-text="courseRemind.sourceName">资源</span>：</span>
                                                    <el-link type="info" :underline="false" :href="courseRemind.url"
                                                        v-text="courseRemind.sourceContent">新资源名称</el-link>
                                                </el-col>
                                            </el-row>
                                            <el-row>
                                                <el-col :span="24">
                                                    <span
                                                        style="float: left;padding-left: 20px; margin-top: 10px; margin-bottom: 10px;">
                                                        <span style="font-size: 12px;color: #999">
                                                            <i class="el-icon-date"></i> <span
                                                                v-text="courseRemind.remindTime">2020-11-23 20:42</span>
                                                            <span>
                                                                <el-button type="text"
                                                                    @click="deleteRemind(courseRemind.id)"
                                                                    style="color: #999; font-size: 10px;">
                                                                    <span
                                                                        v-show="showDel.courseRemindId === courseRemind.id">
                                                                        <i class="el-icon-delete"
                                                                            style="margin-left: 8px; margin-right: 4px;"></i>删除该通知</span>
                                                                </el-button>
                                                            </span>
                                                        </span>
                                                    </span>
                                                </el-col>
                                            </el-row>
                                            <el-divider></el-divider>
                                        </div>
                                    </el-card>
                                    <el-card class="box-card" v-if="courseRemindList.length === 0" shadow="hover"
                                        style="margin-top: 20px;width: 1184px;height: 220px;border-radius: 10px;border-width: 2px">
                                        <el-row>
                                            <p
                                                style="text-align: center; font-size: 15px; color: black; line-height: 160px;">
                                                暂无课程相关提醒</p>
                                        </el-row>
                                    </el-card>
                                </div>

                                <!-- 回复我的 -->
                                <div v-show="visible.isReplyMessageVisible">
                                    <el-card shadow="never"
                                        style="margin-top: 100px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row>
                                            <el-col :span="1.5">
                                                回复我的
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <!-- 回复列表 -->
                                    <el-card shadow="hover" v-if="replyRemindList.length > 0"
                                        style="margin-top: 10px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <div v-for="(replyRemind, index) in replyRemindList"
                                            @mouseover="showDel.replyRemindId = replyRemind.id"
                                            @mouseout="showDel.replyRemindId = -1">
                                            <el-row style="margin-top: 20px;">
                                                <el-col :span="1">
                                                    <el-avatar size="small" :src="replyRemind.sender.avatar">
                                                    </el-avatar>
                                                </el-col>
                                                <el-col :span="2.5" style="margin-top: 5px;">
                                                    <span style="font-size: 14px; color: #222;"
                                                        v-text="replyRemind.sender.username">Colin</span>
                                                    <span style="color: #999; font-size: small;">回复了我的评论：</span>
                                                    <el-link type="info" :underline="false" :href="replyRemind.url"
                                                        v-text="replyRemind.targetContent">我的评论内容</el-link>
                                                </el-col>
                                            </el-row>
                                            <el-row>
                                                <el-col :span="24">
                                                    <span style="float: left;padding-left: 20px;margin-top: 3px;">
                                                        <span style="font-size: 14px;color: #222">
                                                            <el-link type="info" :underline="false"
                                                                :href="replyRemind.url"
                                                                v-text="replyRemind.sourceContent">Colin回复的内容</el-link>
                                                        </span>
                                                    </span>
                                                </el-col>
                                            </el-row>
                                            <el-row>
                                                <el-col :span="24">
                                                    <span
                                                        style="float: left;padding-left: 20px; margin-top: 10px; margin-bottom: 10px;">
                                                        <span style="font-size: 12px;color: #999">
                                                            <i class="el-icon-date"></i> <span
                                                                v-text="replyRemind.remindTime">2020-11-23
                                                                20:42</span>
                                                            <!-- <el-button type="text"
                                                                style="color: #999; font-size: 10px;"> <i
                                                                    class="fa fa-mail-forward"
                                                                    style="margin-left: 4px; margin-right: 4px;"></i>回复
                                                            </el-button>
                                                            <el-button type="text"
                                                                style="color: #999; font-size: 10px;"><i
                                                                    class="fa fa-thumbs-o-up"
                                                                    style="margin-left: 4px; margin-right: 4px;"></i>点赞
                                                            </el-button> -->
                                                            <span>
                                                                <el-popconfirm confirmButtonText="确认"
                                                                    cancelButtonText="取消" confirmButtonType="danger"
                                                                    cancelButtonType="success" placement="right"
                                                                    @onConfirm="deleteRemind(replyRemind.id)"
                                                                    title="确认要删除该通知吗？">
                                                                    <el-button type="text" slot="reference"
                                                                        style="color: #999; font-size: 10px;">
                                                                        <span
                                                                            v-show="showDel.replyRemindId === replyRemind.id">
                                                                            <i class="el-icon-delete"
                                                                                style="margin-left: 8px; margin-right: 4px;"></i>删除该通知</span>
                                                                    </el-button>
                                                                </el-popconfirm>
                                                            </span>
                                                        </span>
                                                    </span>
                                                </el-col>
                                            </el-row>
                                            <el-divider></el-divider>
                                        </div>
                                    </el-card>
                                    <el-card class="box-card" v-if="replyRemindList.length === 0" shadow="hover"
                                        style="margin-top: 20px;width: 1184px;height: 220px;border-radius: 10px;border-width: 2px">
                                        <el-row>
                                            <p
                                                style="text-align: center; font-size: 15px; color: black; line-height: 160px;">
                                                暂无回复我的提醒</p>
                                        </el-row>
                                    </el-card>
                                </div>

                                <!-- 收到的赞 -->
                                <div v-show="visible.isVoteUpMessageVisible">
                                    <el-card shadow="never"
                                        style="margin-top: 100px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row>
                                            <el-col :span="1.5">
                                                收到的赞
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <!-- 收到的赞列表 -->
                                    <el-card shadow="hover" v-if="voteUpRemindList.length > 0"
                                        style="margin-top: 10px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <div v-for="(voteUpRemind, index) in voteUpRemindList" :key="voteUpRemind.id"
                                            @mouseover="showDel.voteUpRemindId = voteUpRemind.id"
                                            @mouseout="showDel.voteUpRemindId = -1">
                                            <el-row style="margin-top: 20px;">
                                                <el-col :span="1">
                                                    <el-avatar size="small" :src="voteUpRemind.sender.avatar">
                                                    </el-avatar>
                                                </el-col>
                                                <el-col :span="2.5" style="margin-top: 5px;">
                                                    <span style="font-size: 14px; color: #222;"
                                                        v-text="voteUpRemind.sender.username">Colin</span>
                                                    <span style="color: #999; font-size: small;">赞了我的评论：</span>
                                                    <el-link type="info" :underline="false" :href="voteUpRemind.url"
                                                        v-text="voteUpRemind.targetContent">我的评论内容</el-link>
                                                </el-col>
                                            </el-row>
                                            <el-row>
                                                <el-col :span="24">
                                                    <span
                                                        style="float: left;padding-left: 20px; margin-top: 10px; margin-bottom: 10px;">
                                                        <span style="font-size: 12px;color: #999">
                                                            <i class="el-icon-date"></i> <span
                                                                v-text="voteUpRemind.remindTime">2020-11-23 20:42</span>
                                                            <span>
                                                                <el-popconfirm confirmButtonText="确认"
                                                                    cancelButtonText="取消" confirmButtonType="danger"
                                                                    cancelButtonType="success" placement="right"
                                                                    @onConfirm="deleteRemind(voteUpRemind.id)"
                                                                    title="确认要删除该通知吗？">
                                                                    <el-button type="text" slot="reference"
                                                                        style="color: #999; font-size: 10px;">
                                                                        <span
                                                                            v-show="showDel.voteUpRemindId === voteUpRemind.id">
                                                                            <i class="el-icon-delete"
                                                                                style="margin-left: 8px; margin-right: 4px;"></i>删除该通知</span>
                                                                    </el-button>
                                                                </el-popconfirm>
                                                            </span>
                                                        </span>
                                                    </span>
                                                </el-col>
                                            </el-row>
                                            <el-divider></el-divider>
                                        </div>
                                    </el-card>
                                    <el-card class="box-card" v-if="voteUpRemindList.length === 0" shadow="hover"
                                        style="margin-top: 20px;width: 1184px;height: 220px;border-radius: 10px;border-width: 2px">
                                        <el-row>
                                            <p
                                                style="text-align: center; font-size: 15px; color: black; line-height: 160px;">
                                                暂无收到的赞提醒</p>
                                        </el-row>
                                    </el-card>
                                </div>

                                <!-- 我的私信 -->
                                <div v-show="visible.isChatMessageVisible">
                                    <el-card shadow="never" id="chat-card"
                                        style="margin-top: 100px; width: 1184px; height: 700px; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <!-- 左侧 toolbar -->
                                        <div style="width: 80px; overflow: hidden; float: left; color: #fff">
                                            <div style="background-color:#9adaf3; height: 700px;">
                                                <el-row>
                                                    <el-link :underline="false"
                                                        style="display: block; width: 80px; height: 80px; color: #fff;
                                                    text-align: center; line-height: 80px; text-indent: 999em; overflow: hidden;
                                                    background: url('https://www.ketangpai.com/Public/Home/img/chaticon.png') no-repeat;"
                                                        :style="active.isLatelyActive ? 'background-position: -80px 0' : 'background-position: 4px 0'"
                                                        @click="change('isLatelyActive')">
                                                    </el-link>
                                                </el-row>
                                                <el-row>
                                                    <el-link :underline="false"
                                                        style="display: block; width: 80px; height: 80px; color: #fff;
                                                text-align: center; line-height: 80px; text-indent: 999em; overflow: hidden;
                                                background: url('https://www.ketangpai.com/Public/Home/img/chaticon.png') no-repeat;"
                                                        :style="active.isClassActive ? 'background-position: -82px -80px' : 'background-position: 4px -80px;'"
                                                        @click="change('isClassActive')">
                                                    </el-link>
                                                </el-row>
                                            </div>
                                        </div>
                                        <!-- 中间 sidebar -->
                                        <div style="float: left; width: 220px; overflow: hidden;">
                                            <div style="background-color:#f3f3f3; height: 700px;">
                                                <el-row>
                                                    <el-input style="margin: 15px 25px 15px 0; width: 150px;"
                                                        v-model="search" placeholder="搜索学号、姓名"
                                                        prefix-icon="el-icon-search"></el-input>
                                                </el-row>
                                                <el-divider></el-divider>
                                                <el-row v-show="active.isClassActive">
                                                    <el-tree style="background-color:#f3f3f3; margin-top: 15px;"
                                                        :data="userList" :props="classProps"
                                                        @node-click="findClassChatMessageList">
                                                        <span class="custom-tree-node" slot-scope="{ node, data }">
                                                            <span>
                                                                <el-avatar size="big" :src="getClassAvatar(data.avatar)"
                                                                    style="height: 16px; width: 16px; margin-right: 5px;">
                                                                </el-avatar>
                                                                <span v-text="data.username">1班(12)</span>
                                                            </span>
                                                        </span>
                                                    </el-tree>
                                                </el-row>
                                                <el-row v-show="!active.isClassActive">
                                                    <el-tree style="background-color:#f3f3f3; margin-top: 15px;"
                                                        :data="latelyUserList" :props="chatProps"
                                                        @node-click="findLatelyChatMessageList" default-expand-all>
                                                        <span class="custom-tree-node" slot-scope="{ node, data }">
                                                            <span>
                                                                <el-avatar size="big" :src="data.avatar"
                                                                    style="height: 16px; width: 16px; margin-right: 5px;">
                                                                </el-avatar>
                                                                <span v-text="data.name">1班(12)</span>
                                                            </span>
                                                        </span>
                                                    </el-tree>
                                                </el-row>
                                            </div>
                                        </div>
                                        <!-- 右侧聊天框 -->
                                        <div style="float: left; width: 880px; overflow: hidden;">
                                            <div style="height: 700px;">
                                                <el-row style="min-height: 70px;">
                                                    <span style="float: left; margin: 24.5px;">
                                                        <span style="color: #222;" v-text="chat.toUser.username">
                                                            Colin
                                                        </span>
                                                        <span v-if="chat.toUser.courseName != ''">
                                                            <span style="color: #aaa; "
                                                                v-text="getChatToUserCourseName(chat.toUser.courseName)">
                                                                1班
                                                            </span>
                                                        </span>
                                                    </span>
                                                </el-row>
                                                <el-divider></el-divider>
                                                <div style="height: 400px; width: 870px; overflow-y: auto;"
                                                    id="chat-box">
                                                    <el-row v-for="(content, index) in chat.messageList" :key="index"
                                                        style="line-height: 40px;">
                                                        <span style="float: right;"
                                                            v-show="content.from.id === user.id">
                                                            <span v-text="content.time"
                                                                style="position: relative; font-size: 12px; color: #aaa">
                                                                2020-11-30 18:05
                                                            </span>
                                                            <span v-text="content.message"
                                                                style="display: inline-block; position: relative;
                                                        padding: 0 10px; min-height: 30px; line-height: 2.5; text-align: left;
                                                        word-break: break-all; background-color: #b2e281; border-radius: 8px;">
                                                                hello!
                                                            </span>
                                                            <img width="30" height="30" style="border-radius: 20px;"
                                                                :src="user.avatar">
                                                            </img>
                                                        </span>
                                                        <span style="float: left; margin-left: 10px;"
                                                            v-show="content.to.id === user.id">
                                                            <img width="30" height="30" style="border-radius: 20px;"
                                                                :src="chat.toUser.avatar">
                                                            </img>
                                                            <span v-text="content.message"
                                                                style="display: inline-block; position: relative;
                                                                padding: 0 10px; min-height: 30px; line-height: 2.5; text-align: left;
                                                                word-break: break-all; background-color: #e4e4e4; border-radius: 8px;">
                                                                hello!
                                                            </span>
                                                            <span v-text="content.time"
                                                                style="position: relative; font-size: 12px; color: #aaa">2020-11-30
                                                                18:05</span>
                                                        </span>
                                                    </el-row>
                                                </div>
                                                <el-divider></el-divider>
                                                <el-row style="height: 150px;">
                                                    <textarea id="chat-textarea" rows='1' cols='50' @keyup.enter="keyUp"
                                                        placeholder="说些什么..."></textarea>
                                                </el-row>
                                                <el-row>
                                                    <el-col :span="8">
                                                        <span
                                                            style="color: #aaa; padding: 0 20px 0 0; font-size: 14px;">按
                                                            Ctrl + Enter 换行，按 Enter 发送</span>
                                                    </el-col>
                                                    <el-col :span="3" style="float: right; margin-right: 20px;">
                                                        <el-button type="primary" @click="sendChatContent()">
                                                            发送</el-button>
                                                    </el-col>
                                                </el-row>
                                            </div>
                                        </div>
                                    </el-card>
                                </div>

                                <!-- 消息设置 -->
                                <div v-show="visible.isMessageSettingVisible">
                                    <el-card shadow="never"
                                        style="margin-top: 100px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row>
                                            <el-col :span="1.5">
                                                消息设置
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <!-- 消息提醒 -->
                                    <el-card shadow="hover"
                                        style="margin-top: 10px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row>
                                            <el-col :span="7.5">
                                                消息提醒 <span
                                                    style="color: #999; font-size: small;">（关闭后，所有消息将不再进行提醒）</span>
                                            </el-col>
                                        </el-row>
                                        <el-row style="margin-top: 10px;">
                                            <el-col :span="7.5">
                                                <el-radio-group v-model="messageSetting.allRemind">
                                                    <el-radio :label=true>开启</el-radio>
                                                    <el-radio :label=false>关闭</el-radio>
                                                </el-radio-group>
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <!-- 课程相关、回复我的、收到点赞 -->
                                    <el-card shadow="hover"
                                        style="margin-top: 10px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row>
                                            <el-col :span="7.5">
                                                课程相关消息提醒 <span
                                                    style="color: #999; font-size: small;">（关闭后，课程相关将不进行提醒）</span>
                                            </el-col>
                                        </el-row>
                                        <el-row style="margin-top: 10px;">
                                            <el-col :span="7.5">
                                                <el-radio-group v-model="messageSetting.course"
                                                    :disabled="!messageSetting.allRemind">
                                                    <el-radio :label=true>开启</el-radio>
                                                    <el-radio :label=false>关闭</el-radio>
                                                </el-radio-group>
                                            </el-col>
                                        </el-row>
                                        <el-divider id="message-setting-divider"></el-divider>
                                        <el-row>
                                            <el-col :span="7.5">
                                                回复我的消息提醒 <span
                                                    style="color: #999; font-size: small;">（关闭后，收到回复将不进行提醒）</span>
                                            </el-col>
                                        </el-row>
                                        <el-row style="margin-top: 10px;">
                                            <el-col :span="7.5">
                                                <el-radio-group v-model="messageSetting.reply"
                                                    :disabled="!messageSetting.allRemind">
                                                    <el-radio :label=true>开启</el-radio>
                                                    <el-radio :label=false>关闭</el-radio>
                                                </el-radio-group>
                                            </el-col>
                                        </el-row>
                                        <el-divider id="message-setting-divider"></el-divider>
                                        <el-row>
                                            <el-col :span="7.5">
                                                收到的赞消息提醒 <span
                                                    style="color: #999; font-size: small;">（关闭后，收到点赞将不进行提醒）</span>
                                            </el-col>
                                        </el-row>
                                        <el-row style="margin-top: 10px;">
                                            <el-col :span="7.5">
                                                <el-radio-group v-model="messageSetting.voteUp"
                                                    :disabled="!messageSetting.allRemind">
                                                    <el-radio :label=true>开启</el-radio>
                                                    <el-radio :label=false>关闭</el-radio>
                                                </el-radio-group>
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <!-- 我的私信 -->
                                    <el-card shadow="hover"
                                        style="margin-top: 10px;width: 1184px;height: auto; border-radius: 10px;border-width: 2px;padding: 0;">
                                        <el-row>
                                            <el-col :span="7.5">
                                                我的私信消息提醒 <span
                                                    style="color: #999; font-size: small;">（关闭后，收到私信将不进行提醒）</span>
                                            </el-col>
                                        </el-row>
                                        <el-row style="margin-top: 10px;">
                                            <el-col :span="7.5">
                                                <el-radio-group v-model="messageSetting.chat"
                                                    :disabled="!messageSetting.allRemind">
                                                    <el-radio :label=true>开启</el-radio>
                                                    <el-radio :label=false>关闭</el-radio>
                                                </el-radio-group>
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                </div>

                            </el-col>
                            <el-col :span="7"></el-col>
                        </el-row>
                    </div>
                </el-main>
            </el-container>
        </el-container>

        <!-- 底部 -->
        <el-footer style="padding-top: 50px">
            <el-row type="flex" justify="center">
                <el-col :span="8"></el-col>
                <el-col :span="8" push="1">
                    <el-menu mode="horizontal">
                        <el-menu-item>关于我们</el-menu-item>
                        <el-menu-item>联系我们</el-menu-item>
                        <el-menu-item>服务条款</el-menu-item>
                        <el-menu-item>浏览器下载</el-menu-item>
                        <el-menu-item>更新动态</el-menu-item>
                    </el-menu>
                </el-col>
                <el-col :span="8"></el-col>
            </el-row>
            <span class="foot-text">Copyright © 2020 yixuetang.com all Rights Reserved. </span>
        </el-footer>
        </el-container>
    </div>
</body>
<script src="https://cdn.bootcss.com/vue/2.6.11/vue.min.js"></script>
<script src="https://cdn.bootcss.com/axios/0.19.2/axios.min.js"></script>
<!-- <script src="https://cdn.bootcss.com/element-ui/2.13.2/index.js"></script> -->
<script src="../js/index.js"></script>
<script src="../js/common.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="../js/date-format.js"></script>

<script>
    new Vue({
        el: '#app',
        data: {
            user: {},
            visible: {
                isSystemMessageVisible: true,
                isMessageSettingVisible: false,
                isCourseMessageVisible: false,
                isReplyMessageVisible: false,
                isVoteUpMessageVisible: false,
                isChatMessageVisible: false
            },
            systemMessageList: [],
            courseRemindList: [],
            replyRemindList: [
                {
                    sender: {}
                }
            ],
            voteUpRemindList: [],
            messageSetting: {
                allRemind: true,
                course: true,
                reply: true,
                voteUp: true,
                chat: true
            },
            unreadMessageCount: {},
            showDel: {
                courseRemindId: -1,
                replyRemindId: -1,
                voteUpRemindId: -1
            },
            active: {
                isLatelyActive: true,
                isClassActive: false
            },
            userList: [],
            classProps: {
                children: 'userList',
                label: 'username'
            },
            chatProps: {
                children: 'chatUserList',
                label: 'name'
            },
            search: "",
            chat: {
                toUser: {
                    courseName: "",
                    username: "",
                },
                fromUser: {
                    username: "",
                    avatar: ""
                },
                messageList: []
            },
            websocket: null,
            latelyUserList: [
                {
                    name: "最近聊天用户列表",
                    chatUserList: []
                }
            ], // 最近聊天用户列表
        },
        methods: {
            verify() {
                yxt.http.get("/auth/verify/2").then(({ data }) => {
                    if (data.success) {
                        this.user = data.queryResult.data[0];
                        this.getUserMessageSetting();
                        this.getMessageData();
                        this.getRemindData();
                        this.getUserList();
                        this.initWebSocket();
                        this.getLatelyUserList();
                    } else {
                        location.href = "../index.html"
                    }
                }).catch(() => {
                    location.href = "../index.html";
                });
            },
            logout() {
                yxt.http.delete("/auth/logout/2").then(({ data }) => {
                    if (data.success) {
                        location.href = "../login.html"
                    } else {
                        this.$message.error("服务器繁忙，请稍候再试！");
                    }
                }).catch(() => {
                    this.$message.error("服务器繁忙，请稍候再试！");
                })
            },
            getUserMessageSetting() {
                yxt.http.get("message/setting/userId/" + this.user.id).then(({ data }) => {
                    this.messageSetting = data.queryResult.data[0];
                })
            },
            updateUserMessageSetting() {
                yxt.http.put("message/setting/userId/" + this.user.id, this.messageSetting).then(({ data }) => {
                    if (!data.success) {
                        this.$message.error(data.message);
                    }
                }).catch(() => {
                    this.$message.error("服务器繁忙，请稍候再试！");
                })
            },
            getMessageData() {
                yxt.http.get("message/userId/" + this.user.id).then(({ data }) => {
                    if (data.success) {
                        this.systemMessageList = data.queryResult.data;
                        this.getUnreadMessageCount();
                    }
                })
            },
            getRemindData() {
                yxt.http.get("message/eventRemind/userId/" + this.user.id).then(({ data }) => {
                    if (data.success) {
                        let remindList = data.queryResult.data;
                        remindList.forEach(remind => remind.remindTime = remind.remindTime.substring(0, 16));
                        this.courseRemindList = remindList.filter(courseRemind => courseRemind.remindType === 0);
                        this.replyRemindList = remindList.filter(replyRemind => replyRemind.remindType === 1);
                        this.voteUpRemindList = remindList.filter(voteUpRemind => voteUpRemind.remindType === 2);
                    }
                })
            },
            show(key) {
                for (let k in this.visible) {
                    this.visible[k] = k === key;
                }
                if (this.visible.isChatMessageVisible) {
                    this.scroll();
                }
            },
            change(key) {
                for (let k in this.active) {
                    this.active[k] = k === key;
                }
                if (key === 'isLatelyActive') {
                    this.getLatelyUserList();
                }
            },
            getUnreadMessageCount() {
                yxt.http.get("message/unreadCount/userId/" + this.user.id).then(({ data }) => {
                    if (data.success) {
                        this.unreadMessageCount = data.queryResult.data[0];
                    }
                })
            },
            deleteRemind(remindId) {
                yxt.http.delete("/message/eventRemind/remindId/" + remindId + "/userId/" + this.user.id).then(({ data }) => {
                    if (data.success) {
                        this.$message.success(data.message);
                        this.getRemindData();
                    } else {
                        this.$message.error(data.message);
                    }
                }).catch(() => {
                    this.$message.error("服务器繁忙，请稍候再试！")
                });
            },
            findClassChatMessageList(data) {
                if (!data.userList && data.id != this.user.id) {
                    this.chat.toUser = {
                        userId: data.id,
                        courseName: data.courseName,
                        username: data.username,
                        avatar: data.avatar
                    };
                    this.getMessageList();
                }
            },
            findLatelyChatMessageList(data) {
                if (!data.chatUserList && data.id != this.user.id) {
                    this.chat.toUser = {
                        userId: data.id,
                        username: data.name,
                        avatar: data.avatar
                    };
                    this.getMessageList();
                }
            },
            getUserList() {
                yxt.http.get("users/courseUser/userId/" + this.user.id + "?search=" + this.search).then(({ data }) => {
                    if (data.success) {
                        this.userList = data.queryResult.data;
                    }
                })
            },
            getMessageList() {
                yxt.http.get("message/chat/self/fromId/" + this.user.id + "/toId/" + this.chat.toUser.userId).then(({ data }) => {
                    if (data.success) {
                        this.chat.messageList = data.queryResult.data;
                    }
                    this.scroll();
                })
            },
            scroll() {
                setTimeout(() => {
                    var chatBox = document.getElementById('chat-box');
                    // chatBox.scrollTop = 10000000;
                    chatBox.scrollTo(0, 10000000)
                }, 200);
            },
            getClassAvatar(avatar) {
                if (!avatar) {
                    return "http://www.pava.run/group1/M00/00/02/rBAABV_E4CeAV5qDAAAg8abH-rE007.jpg";
                }
                return avatar;
            },
            sendChatContent() {
                let contentText = document.getElementById("chat-textarea").value;
                contentText = contentText.replace(/[\n\r]/gi, "");
                if (contentText === '') {
                    this.$message.error("请输入要发送的内容！")
                    return;
                }
                let chatMessage = {
                    from: {
                        id: this.user.id,
                        name: this.user.username,
                        avatar: this.user.avatar
                    },
                    message: contentText,
                    to: {
                        id: this.chat.toUser.userId,
                        name: this.chat.toUser.name,
                        avatar: this.chat.toUser.avatar
                    },
                    time: new Date().Format("yyyy-MM-dd hh:mm:ss")
                }
                yxt.http.post("message/chat/toId/" + this.chat.toUser.userId, chatMessage).then(({ data }) => {
                    if (data.success) {
                        document.getElementById("chat-textarea").value = '';
                        this.getMessageList();
                    }
                })
            },
            keyUp(e) {
                if (e.ctrlKey && e.keyCode == 13) {   // 用户点击了 ctrl + enter 触发
                    document.getElementById("chat-textarea").value += '\n';
                } else { // 用户点击了 enter 触发
                    this.sendChatContent();
                }
            },
            initWebSocket() {
                this.websocket = new WebSocket('ws://127.0.0.1:8888/chat/' + this.user.id)
                // 接收到消息时回调
                this.websocket.onmessage = ({ data }) => {
                    let toUser = JSON.parse(data);
                    this.chat.toUser = {
                        userId: toUser.id,
                        username: toUser.name,
                        avatar: toUser.avatar
                    };
                    this.getMessageList();
                }
            },
            getLatelyUserList() {
                yxt.http.get("message/chat/lately/userId/" + this.user.id).then(({ data }) => {
                    if (data.success) {
                        this.latelyUserList = [
                            {
                                name: "最近聊天用户列表",
                                chatUserList: data.queryResult.data
                            }
                        ]
                        this.chat.toUser = {
                            userId: this.latelyUserList[0].chatUserList[0].id,
                            username: this.latelyUserList[0].chatUserList[0].name,
                            avatar: this.latelyUserList[0].chatUserList[0].avatar
                        };
                        this.getMessageList();
                    }
                })
            },
            getChatToUserCourseName(courseName) {
                if (courseName != undefined) {
                    return "( " + courseName + " )"
                }
                return ""
            }
        },
        created() {
            this.verify();
        },
        watch: {
            messageSetting: {
                deep: true,
                handler() {
                    this.updateUserMessageSetting();
                },
            },
            search: {
                handler() {
                    this.getUserList();
                }
            }
        },
        computed: {
            totalUnreadCount() {
                let totalCount = 0;
                for (let key in this.unreadMessageCount) {
                    totalCount += this.unreadMessageCount[key];
                }
                return totalCount;
            }
        },
    })
</script>

</html>